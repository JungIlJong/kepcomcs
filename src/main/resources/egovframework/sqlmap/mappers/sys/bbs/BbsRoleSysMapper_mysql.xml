<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kepco.app.domain.bbs.mapper.BbsRoleSysMapper">

    <!-- 권한을 생성한다. -->
    <insert id="insertBbsRole" parameterType="map">
        INSERT INTO VST_BBS_AUTHRT (
                BBS_ID,
                AUTHRT_ID,
                AUTHOR_LIST
        ) VALUES
            <foreach collection="roles" item="item" separator=",">
                <trim prefix="(" suffix=")">
                    #{bbsId},
                    #{item.authrtId},
                    #{item.author}
                </trim>
            </foreach>
    </insert>

    <!-- 게시판의 권한을 삭제한다. -->
    <delete id="deleteBbsRole" parameterType="String">
        DELETE FROM VST_BBS_AUTHRT WHERE BBS_ID = #{bbsId}
    </delete>

    <!-- 관리자의 게시판 권한을 가져온다.(Y/N/Null) -->
    <select id="checkBbsRole" parameterType="map" resultType="String">
        SELECT B.USE_AT FROM  VST_BBS B
        LEFT OUTER JOIN VST_BBS_AUTHRT C ON C.BBS_ID = B.BBS_ID
        LEFT OUTER JOIN VST_MBR_AUTHRT D ON D.AUTHRT_ID = C.AUTHRT_ID
        <if test="nttId != null">
            LEFT OUTER JOIN VST_NTT A ON A.BBS_ID = B.BBS_ID
        </if>
        WHERE D.MBR_ID = #{mbrId} AND B.USE_AT = 'Y' AND C.AUTHOR_LIST LIKE CONCAT('%', #{action}, '%')
        <if test="bbsId != null">
            AND B.BBS_ID = #{bbsId}
        </if>
        <if test="nttId != null">
            AND A.NTT_ID = #{nttId}
        </if>
        ORDER BY C.AUTHOR_LIST DESC
        LIMIT 1
    </select>

    <!-- 권한 목록을 조회한다. -->
    <select id="selectBbsRole" parameterType="Map" resultType="egovMap">
        SELECT A.AUTHRT_ID, A.AUTHRT_CD, A.AUTHRT_NM, IFNULL(B.AUTHOR_LIST, 0) AUTHOR_LIST
        FROM VST_AUTHRT A
        LEFT OUTER JOIN VST_BBS_AUTHRT B ON A.AUTHRT_ID = B.AUTHRT_ID AND B.BBS_ID = #{bbsId}
        ORDER BY A.AUTHRT_ID
    </select>

    <!-- 모든 권한 목록을 조회한다. -->
    <select id="selectRoleListAll" resultType="egovMap">
        SELECT * FROM VST_AUTHRT;
    </select>
</mapper>