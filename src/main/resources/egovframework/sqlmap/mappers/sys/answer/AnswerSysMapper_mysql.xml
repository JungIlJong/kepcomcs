<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kepco.app.domain.answer.mapper.AnswerSysMapper">

    <!-- 댓글을 생성한다. -->
    <insert id="insertAnswer" parameterType="sysAnswer">
        INSERT INTO VST_ANSWER (
            NTT_ID,
            ANSWER_CN,
            USE_AT,
            FRST_REGISTER_ID,
            FRST_REGIST_DT
        ) VALUES (
            #{nttId},
            #{answerCn},
            'Y',
            #{frstRegisterId},
            NOW()
        )
    </insert>

    <!-- 댓글을 수정한다. -->
    <update id="updateAnswer" parameterType="sysAnswer">
        UPDATE
            VST_ANSWER
        SET
            USE_AT = CASE
                WHEN USE_AT = 'Y' THEN 'N'
                ELSE 'Y'
            END,
            LAST_UPDUSR_ID = #{lastUpdusrId},
            LAST_UPDT_DT = NOW()
        WHERE ANSWER_ID = #{answerId}
    </update>

    <!-- 댓글을 삭제한다. -->
    <delete id="deleteAnswerById" parameterType="String">
        DELETE FROM VST_ANSWER WHERE ANSWER_ID = #{answerId}
    </delete>

    <!-- 게시글의 댓글을 생성한다. -->
    <delete id="deleteAnswerByNttId" parameterType="String">
        DELETE FROM VST_ANSWER WHERE NTT_ID = #{nttId}
    </delete>

    <!-- 댓글을 목록 정보를 조회한다. -->
    <select id="selectAnswerList" parameterType="Map" resultType="egovMap">
        SELECT
            A.ANSWER_ID,
            A.NTT_ID,
            A.ANSWER_CN,
            A.USE_AT,
            A.WRTER_NM,
            DATE_FORMAT(A.FRST_REGIST_DT, '%Y-%m-%d %H:%i') FRST_REGIST_DT
        FROM VST_ANSWER A
        WHERE 1 = 1 AND A.NTT_ID = #{nttId}
        <if test="searchKeyword != null and searchKeyword != ''">
            AND (A.ANSWER_CN LIKE CONCAT('%', #{searchKeyword}, '%') OR A.WRTER_NM LIKE CONCAT('%', #{searchKeyword}, '%'))
        </if>
        ORDER BY
        <choose>
            <when test="orderColumn != null and orderColumn != ''">
                ${orderColumn}
            </when>
            <otherwise>
                A.FRST_REGIST_DT
            </otherwise>
        </choose>
        <choose>
            <when test="ascDesc != null and ascDesc != ''">
                ${ascDesc}
            </when>
            <otherwise>
                DESC
            </otherwise>
        </choose>
        LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>

    <!-- 댓글 총 갯수를 조회한다. -->
    <select id="selectAnswerTotCnt" parameterType="Map" resultType="int">
        SELECT
            COUNT(*)
        FROM VST_ANSWER
        WHERE 1 = 1 AND NTT_ID = #{nttId}
        <if test="searchKeyword != null and searchKeyword != ''">
            AND (ANSWER_CN LIKE CONCAT('%', #{searchKeyword}, '%') OR WRTER_NM LIKE CONCAT('%', #{searchKeyword}, '%'))
        </if>
    </select>
</mapper>