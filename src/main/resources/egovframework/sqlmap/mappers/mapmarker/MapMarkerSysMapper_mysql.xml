<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kepco.app.domain.mapmarker.mapper.MapMarkerSysMapper">

    <insert id="insertMapMarker" parameterType="com.kepco.app.domain.mapmarker.dto.MapMarker">
        INSERT INTO VST_MAP_MARKER (
            NAME,
            DESCRIPTION,
            LATITUDE,
            LONGITUDE,
            ICON_URL,
            road_address,
            jibun_address,
            detail_address,
            CATEGORY_CODE1,
            CATEGORY_CODE2,
            USE_YN
        ) VALUES (
            #{name},
            #{description},
            #{latitude},
            #{longitude},
            #{iconUrl},
            #{roadAddress},
            #{jibunAddress},
            #{detailAddress},
            #{categoryCode1},
            #{categoryCode2},
            #{useYn}
        )
    </insert>

    <select id="searchMapMarkerList"
            parameterType="com.kepco.app.domain.mapmarker.dto.SearchMapMarkerRequest"
            resultType="com.kepco.app.domain.mapmarker.dto.SearchMapMarkerResponse">
        SELECT
            MARKER_ID as markerId,
            NAME as name,
            DESCRIPTION as description,
            LATITUDE as latitude,
            LONGITUDE as longitude,
            ICON_URL as iconUrl,
            road_address as roadAddress,
            jibun_address as jibunAddress,
            detail_address as detailAddress,
            CATEGORY_CODE1 as categoryCode1,
            CATEGORY_CODE2 as categoryCode2,
            CREATED_AT as createdAt,
            UPDATED_AT as updatedAt,
            USE_YN as useYn
        FROM VST_MAP_MARKER
        <where>
            <if test="categoryCode1 != null and !categoryCode1.isEmpty()">
                AND CATEGORY_CODE1 = #{categoryCode1}
            </if>
            <if test="categoryCode2 != null and !categoryCode2.isEmpty()">
                AND CATEGORY_CODE2 = #{categoryCode2}
            </if>
            <if test="searchKeyword != null and !searchKeyword.isEmpty()">
                <choose>
                    <when test="searchCondition != null and searchCondition == 'name'">
                        AND NAME LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="searchCondition != null and searchCondition == 'address'">
                        AND (road_address LIKE CONCAT('%', #{searchKeyword}, '%') 
                             OR jibun_address LIKE CONCAT('%', #{searchKeyword}, '%')
                             OR detail_address LIKE CONCAT('%', #{searchKeyword}, '%'))
                    </when>
                    <otherwise>
                        AND (NAME LIKE CONCAT('%', #{searchKeyword}, '%')
                             OR DESCRIPTION LIKE CONCAT('%', #{searchKeyword}, '%')
                             OR road_address LIKE CONCAT('%', #{searchKeyword}, '%')
                             OR jibun_address LIKE CONCAT('%', #{searchKeyword}, '%')
                             OR detail_address LIKE CONCAT('%', #{searchKeyword}, '%'))
                    </otherwise>
                </choose>
            </if>
        </where>
        ORDER BY MARKER_ID DESC
        LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>
    
    <select id="searchMapMarkerTotCnt"
            parameterType="com.kepco.app.domain.mapmarker.dto.SearchMapMarkerRequest"
            resultType="int">
        SELECT
            COUNT(*)
        FROM VST_MAP_MARKER
        <where>
            <if test="categoryCode1 != null and !categoryCode1.isEmpty()">
                AND CATEGORY_CODE1 = #{categoryCode1}
            </if>
            <if test="categoryCode2 != null and !categoryCode2.isEmpty()">
                AND CATEGORY_CODE2 = #{categoryCode2}
            </if>
            <if test="searchKeyword != null and !searchKeyword.isEmpty()">
                <choose>
                    <when test="searchCondition != null and searchCondition == 'name'">
                        AND NAME LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="searchCondition != null and searchCondition == 'address'">
                        AND (road_address LIKE CONCAT('%', #{searchKeyword}, '%') 
                             OR jibun_address LIKE CONCAT('%', #{searchKeyword}, '%')
                             OR detail_address LIKE CONCAT('%', #{searchKeyword}, '%'))
                    </when>
                    <otherwise>
                        AND (NAME LIKE CONCAT('%', #{searchKeyword}, '%')
                             OR DESCRIPTION LIKE CONCAT('%', #{searchKeyword}, '%')
                             OR road_address LIKE CONCAT('%', #{searchKeyword}, '%')
                             OR jibun_address LIKE CONCAT('%', #{searchKeyword}, '%')
                             OR detail_address LIKE CONCAT('%', #{searchKeyword}, '%'))
                    </otherwise>
                </choose>
            </if>
        </where>
    </select>

    <select id="detailMapMarker"
            parameterType="Long"
            resultType="com.kepco.app.domain.mapmarker.dto.DetailMapMarkerResponse">
        SELECT
            MARKER_ID as markerId,
            NAME as name,
            DESCRIPTION as description,
            LATITUDE as latitude,
            LONGITUDE as longitude,
            ICON_URL as iconUrl,
            road_address as roadAddress,
            jibun_address as jibunAddress,
            detail_address as detailAddress,
            CATEGORY_CODE1 as categoryCode1,
            CATEGORY_CODE2 as categoryCode2,
            CREATED_AT as createdAt,
            UPDATED_AT as updatedAt,
            USE_YN as useYn
        FROM VST_MAP_MARKER
        WHERE MARKER_ID = #{markerId}
    </select>

    <select id="findById"
            parameterType="Long"
            resultType="com.kepco.app.domain.mapmarker.dto.MapMarker">
        SELECT
            MARKER_ID as markerId,
            NAME as name,
            DESCRIPTION as description,
            LATITUDE as latitude,
            LONGITUDE as longitude,
            ICON_URL as iconUrl,
            road_address as roadAddress,
            jibun_address as jibunAddress,
            detail_address as detailAddress,
            CATEGORY_CODE1 as categoryCode1,
            CATEGORY_CODE2 as categoryCode2,
            CREATED_AT as createdAt,
            UPDATED_AT as updatedAt,
            USE_YN as useYn
        FROM VST_MAP_MARKER
        WHERE MARKER_ID = #{markerId}
    </select>
    
    <update id="updateMapMarker" parameterType="com.kepco.app.domain.mapmarker.dto.MapMarker">
        UPDATE VST_MAP_MARKER
        SET 
            NAME = #{name},
            DESCRIPTION = #{description},
            LATITUDE = #{latitude},
            LONGITUDE = #{longitude},
            ICON_URL = #{iconUrl},
            road_address = #{roadAddress},
            jibun_address = #{jibunAddress},
            detail_address = #{detailAddress},
            CATEGORY_CODE1 = #{categoryCode1},
            CATEGORY_CODE2 = #{categoryCode2},
            UPDATED_AT = NOW(),
            USE_YN = #{useYn}
        WHERE MARKER_ID = #{markerId}
    </update>

    <update id="updateMapMarkerUseYn" parameterType="map">
        UPDATE VST_MAP_MARKER
        SET USE_YN = #{useYn}
        WHERE MARKER_ID = #{markerId}
    </update>

    <delete id="deleteMapMarker" parameterType="Long">
        DELETE FROM VST_MAP_MARKER WHERE MARKER_ID = #{markerId}
    </delete>


</mapper>
