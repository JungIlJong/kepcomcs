<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kepco.app.domain.report.mapper.ReportSysMapper">

    <resultMap id="listMap" type="com.kepco.app.domain.report.dto.SearchReportResponse">
        <id property="reportId" column="REPORT_ID" />
        <result property="targetType" column="TARGET_TYPE" />
        <result property="createdAt" column="CREATED_AT" />

        <association property="target" javaType="com.kepco.app.domain.report.dto.SearchReportResponse$Target">
            <id property="targetId" column="TARGET_ID" />
            <result property="targetName" column="TARGET_NAME" />
        </association>

        <association property="reporter" javaType="com.kepco.app.domain.report.dto.SearchReportResponse$Reporter">
            <id property="mbrId" column="MBR_ID" />
            <result property="mbrNm" column="MBR_NM" />
        </association>
    </resultMap>

    <select
            id="searchReportList"
            parameterType="com.kepco.app.domain.report.dto.SearchReportRequest"
            resultMap="listMap">
        SELECT
            r.REPORT_ID,
            r.TARGET_TYPE,
            r.TARGET_ID,
            r.REPORTER_ID,
            r.REASON_CODE,
            r.DETAIL_MESSAGE,
            r.CREATED_AT,
            CASE
                WHEN r.TARGET_TYPE = 'ntt' THEN n.NTT_SJ
                WHEN r.TARGET_TYPE = 'mbr' THEN m.MBR_NM
                WHEN r.TARGET_TYPE = 'answer' THEN a.ANSWER_CN
            END AS target_name,
            t.MBR_ID,
            t.MBR_NM
        FROM VST_REPORT r
        LEFT JOIN VST_NTT n ON r.TARGET_TYPE = 'ntt' AND r.TARGET_ID = n.NTT_ID
        LEFT JOIN VST_MBR m ON r.TARGET_TYPE = 'mbr' AND r.TARGET_ID = m.MBR_ID
        LEFT JOIN VST_ANSWER a ON r.TARGET_TYPE = 'answer' AND r.TARGET_ID = a.ANSWER_ID
        INNER JOIN VST_MBR t ON r.REPORTER_ID = t.MBR_ID
        <where>
            <if test="!searchKeyword.isEmpty()">
                <choose>
                    <when test="!searchCondition.isEmpty() and searchCondition == 'ntt'">
                        AND n.NTT_SJ LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="!searchCondition.isEmpty() and searchCondition == 'answer'">
                        AND a.ANSWER_CN LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="!searchCondition.isEmpty() and searchCondition == 'mbr'">
                        AND m.MBR_NM LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <otherwise>
                        AND (n.NTT_SJ LIKE CONCAT('%', #{searchKeyword}, '%') OR a.ANSWER_CN LIKE CONCAT('%', #{searchKeyword}, '%') OR m.MBR_NM LIKE CONCAT('%', #{searchKeyword}, '%'))
                    </otherwise>
                </choose>
            </if>
        </where>
        ORDER BY r.REPORT_ID DESC
        LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>

    <select
            id="searchReportTotCnt"
            parameterType="com.kepco.app.domain.report.dto.SearchReportRequest"
            resultType="int">
        SELECT
            COUNT(*)
        FROM VST_REPORT r
        LEFT JOIN VST_NTT n ON r.TARGET_TYPE = 'ntt' AND r.TARGET_ID = n.NTT_ID
        LEFT JOIN VST_MBR m ON r.TARGET_TYPE = 'mbr' AND r.TARGET_ID = m.MBR_ID
        LEFT JOIN VST_ANSWER a ON r.TARGET_TYPE = 'answer' AND r.TARGET_ID = a.ANSWER_ID
        INNER JOIN VST_MBR t ON r.REPORTER_ID = t.MBR_ID
        <where>
            <if test="!searchKeyword.isEmpty()">
                <choose>
                    <when test="!searchCondition.isEmpty() and searchCondition == 'ntt'">
                        AND n.NTT_SJ LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="!searchCondition.isEmpty() and searchCondition == 'answer'">
                        AND a.ANSWER_CN LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <when test="!searchCondition.isEmpty() and searchCondition == 'mbr'">
                        AND m.MBR_NM LIKE CONCAT('%', #{searchKeyword}, '%')
                    </when>
                    <otherwise>
                        AND (n.NTT_SJ LIKE CONCAT('%', #{searchKeyword}, '%') OR a.ANSWER_CN LIKE CONCAT('%', #{searchKeyword}, '%') OR m.MBR_NM LIKE CONCAT('%', #{searchKeyword}, '%'))
                    </otherwise>
                </choose>
            </if>
        </where>
    </select>

    <select
        id="selectAnswerWithReport"
        parameterType="long"
        resultType="com.kepco.app.domain.report.dto.AnswerReportDetailResponse">
        SELECT
            r.REPORT_ID,
            r.TARGET_TYPE,
            r.TARGET_ID,
            r.REPORTER_ID,
            r.REASON_CODE,
            r.DETAIL_MESSAGE,
            r.CREATED_AT,
            a.ANSWER_ID AS answerId,
            a.ANSWER_CN AS answerContent,
            n.NTT_ID AS postId,
            n.NTT_SJ AS postTitle,
            m.MBR_ID AS reporterId,
            m.MBR_NM AS reporterName
        FROM VST_REPORT r
        INNER JOIN VST_ANSWER a ON r.TARGET_TYPE = 'answer' AND r.TARGET_ID = a.ANSWER_ID
        INNER JOIN VST_NTT n ON a.NTT_ID = n.NTT_ID
        INNER JOIN VST_MBR m ON r.REPORTER_ID = m.MBR_ID
        WHERE r.REPORT_ID = #{reportId}
    </select>

    <select id="selectNttWithReport"
            parameterType="long"
            resultType="com.kepco.app.domain.report.dto.NttReportDetailResponse">
        SELECT
            r.REPORT_ID,
            r.TARGET_TYPE,
            r.TARGET_ID,
            r.REPORTER_ID,
            r.REASON_CODE,
            r.DETAIL_MESSAGE,
            r.CREATED_AT,
            n.NTT_ID AS nttId,
            n.NTT_SJ AS nttTitle,
            n.NTT_CN AS nttContent,
            w.MBR_NM AS writerName,
            m.MBR_ID AS reporterId,
            m.MBR_NM AS reporterName
        FROM VST_REPORT r
        INNER JOIN VST_NTT n ON r.TARGET_TYPE = 'ntt' AND r.TARGET_ID = n.NTT_ID
        INNER JOIN VST_MBR w ON n.FRST_REGISTER_ID = w.MBR_ID
        INNER JOIN VST_MBR m ON r.REPORTER_ID = m.MBR_ID
        WHERE r.REPORT_ID = #{reportId}
    </select>

    <select id="selectMbrWithReport"
            parameterType="long"
            resultType="com.kepco.app.domain.report.dto.MbrReportDetailResponse">
        SELECT
            r.REPORT_ID,
            r.TARGET_TYPE,
            r.TARGET_ID,
            r.REPORTER_ID,
            r.REASON_CODE,
            r.DETAIL_MESSAGE,
            r.CREATED_AT,
            m.MBR_ID AS mbrId,
            m.MBR_NM AS mbrName,
            m.EML_ADDR AS mbrEmail,
            m.MBL_TELNO AS mbrMobile,
            m2.MBR_ID AS reporterId,
            m2.MBR_NM AS reporterName
        FROM VST_REPORT r
        INNER JOIN VST_MBR m ON r.TARGET_TYPE = 'mbr' AND r.TARGET_ID = m.MBR_ID
        INNER JOIN VST_MBR m2 ON r.REPORTER_ID = m2.MBR_ID
        WHERE r.REPORT_ID = #{reportId}
    </select>

    <delete id="deleteReport" parameterType="Long">
        DELETE FROM VST_REPORT WHERE REPORT_ID = #{reportId}
    </delete>

    <delete id="resetReport" parameterType="com.kepco.app.domain.report.dto.ResetReportRequest">
        DELETE FROM VST_REPORT WHERE TARGET_TYPE = #{targetType} AND TARGET_ID = #{targetId}
    </delete>
</mapper>
